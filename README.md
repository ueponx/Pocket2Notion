# Pocket to Notion インポートツール（Pocket2Notion）

PocketのCSVエクスポートデータをNotionデータベースに取り込むPythonプログラムです。
Pocketのサービス終了（2025年7月）に備え、蓄積された記事をNotionに移行できます。

## 特徴

- **CSV形式対応**: Pocketの最新エクスポート形式（CSV/ZIP）に対応
- **複数ファイル対応**: 10,000件ずつ分割されたCSVファイルを自動処理
- **レート制限対応**: Notion APIの制限を考慮した自動待機機能

## 必要要件

- Python 3.8以上
- Notionアカウント
- Pocketアカウント

## インストール

### 1. リポジトリのクローンまたはダウンロード

```bash
git clone <repository-url>
cd Pocket2Notion
```

### 2. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 3. 環境設定ファイルの作成

```bash
cp env.example .env
```

## セットアップ

### Notion側の準備

#### 1. Integration の作成

1. [Notion Developers](https://www.notion.so/profile/integrations) にアクセス
2. 「新しいインテグレーション」をクリック
3. インテグレーション名を入力（例：「Pocket CSV Importer」）
4. 関連ワークスペースを選択
5. 「保存」をクリック
6. 表示された「内部インテグレーションシークレット（トークン）」をコピー（後で使用）

⚠️ **重要**: このトークンは絶対に外部に漏らさないよう注意してください。

#### 2. データベースの作成

Notionで新しいデータベースを作成し、以下のプロパティを設定してください：

##### 必須プロパティ

| プロパティ名 | プロパティタイプ | 説明 |
|-------------|-----------------|------|
| `Title` | Title（デフォルト） | 記事のタイトル |
| `URL` | URL | 記事のURL |
| `Domain` | テキスト | ウェブサイトのドメイン名（自動抽出） |
| `Source` | 選択 | データソース（「Pocket」を選択肢として作成） |

##### オプションプロパティ（お好みで追加）

| プロパティ名 | プロパティタイプ | 説明 |
|-------------|-----------------|------|
| `Status` | 選択 | 元のPocketでのステータス（Unread/Archive） |
| `AddedDate` | 日付 | Pocketに追加された日時 |
| `Tags` | マルチセレクト | 記事のタグ |
| `ReadingStatus` | 選択 | 新しい読了状況（未読、読了、保留など） |
| `Rating` | 選択 | 記事の評価（⭐-⭐⭐⭐⭐⭐） |

##### 選択プロパティのオプション設定

**Sourceオプション**:
- `Pocket`（必須）

**Statusオプション**:
- `Unread`
- `Archive`

**ReadingStatusオプション**:
- `未読`
- `読了`
- `保留`
- `要再読`

**Ratingオプション**:
- `なし`
- `⭐⭐⭐⭐⭐`
- `⭐⭐⭐⭐`
- `⭐⭐⭐`
- `⭐⭐`
- `⭐`

#### 3. データベースの共有設定

1. 作成したデータベースページの右上「…」をクリック
2. 「接続」をクリック
3. 作成したインテグレーション「Pocket CSV Importer」を検索して選択
4. 「はい」をクリック

#### 4. データベースIDの取得

データベースのURLからIDを取得します：
```
https://www.notion.so/[ドメイン名]/[DATABASE_ID]?v=[VIEW_ID]
                                  ^^^^^^^^^^^^
                                  この32桁がDatabase ID
```

### Pocket側の準備

#### エクスポート方法

1. [Pocket](https://getpocket.com/export) にログイン
2. 「CSVファイルをエクスポート」をクリック
3. エクスポート要求の確認メッセージが表示される
4. 最大24時間以内（通常は数分）でメールが届く
5. メール内のリンクから`pocket.zip`ファイルをダウンロード

#### 注意点

- 大量のデータがある場合は処理に時間がかかる
- ダウンロードリンクは3日で有効期限切れ
- 10,000件を超える場合、複数のCSVファイルに分割される

#### エクスポートファイルの構造

```
pocket.zip
├── pocket_data_1.csv    # 1〜10,000件目
├── pocket_data_2.csv    # 10,001〜20,000件目（データが多い場合）
└── ...                  # 必要に応じて追加のCSVファイル
```

### 設定ファイルの編集

`.env`ファイルを編集して、取得した情報を入力してください：

```env
# Notion設定（必須）
NOTION_TOKEN=secret_your_integration_token_here
NOTION_DATABASE_ID=your_database_id_here

# Pocketエクスポートファイル設定
POCKET_FILE=pocket.zip

# API制御設定（オプション）
API_DELAY=0.3
```

### 設定パラメータの詳細

| パラメータ | 必須 | デフォルト値 | 説明 |
|-----------|------|-------------|------|
| `NOTION_TOKEN` | ◯ | なし | Notion Integration Token |
| `NOTION_DATABASE_ID` | ◯ | なし | 対象となるNotionデータベースのID |
| `POCKET_FILE` | △ | `pocket.zip` | Pocketエクスポートファイルのパス（CSVまたはZIP） |
| `API_DELAY` | △ | `0.3` | API呼び出し間隔（秒）- レート制限対策 |

## 使用方法

### ファイル配置

プロジェクトディレクトリに以下のように配置してください：

```
Pocket2Notion/
├── pocket2notion.py     # メインプログラム
├── requirements.txt     # 依存ライブラリ
├── .env.example        # 設定テンプレート
├── .env                # 実際の設定
└── pocket.zip          # Pocketエクスポートファイル
```

### 基本的な実行

```bash
python pocket2notion.py
```

### 実行例

```
2025-06-06 10:30:15,123 - INFO - データベースプロパティの確認が完了しました
2025-06-06 10:30:15,124 - INFO - ZIPファイルから2個のCSVファイルを抽出しました
2025-06-06 10:30:15,125 - INFO - CSVファイルから15,234件の記事を解析しました
2025-06-06 10:30:15,126 - INFO - 15,234件の記事のインポートを開始します...
2025-06-06 10:30:15,127 - INFO - 記事 1/15,234 を処理中
2025-06-06 10:30:15,456 - INFO - インポート成功: とほほのＷＷＷ入門...
...

インポートが正常に完了しました
総記事数: 15,234
インポート成功: 15,198
エラー: 36
成功率: 99.8%
```

## Notion APIの制限事項

Notion APIには以下のレート制限があります：

- **同時リクエスト制限**: 1つのIntegrationあたり**平均で毎秒3リクエストまで**（短期的なバーストは許容）
- **HTTP接続の同時数に明確な制限はない**が、レート制限に達すると`429 Too Many Requests`が返る

大量のCSVデータを移行する際は、上記の制限を考慮して処理間隔を調整します。今回は0.3秒の待機時間を設けています。

## データ移行について

### 処理されるデータ

- **タイトル**: 記事のタイトル（空の場合はURLを使用）
- **URL**: 記事のURL（必須）
- **ドメイン**: URLから自動抽出
- **タグ**: カンマ区切りまたは単一タグに対応
- **追加日時**: Unix timestampから日時に変換
- **ステータス**: unread/archiveの状態

### データ制限

- **タイトル**: 100文字まで（Notionの制限）
- **タグ**: 最大10個まで、各タグ名は100文字まで
- **エンコーディング**: UTF-8、CP1252、Shift_JIS対応

## 開発者向け情報

### 主要クラス

- `PocketToNotionImporter`: メインのインポート処理クラス
  - `extract_csv_from_zip()`: ZIPファイルの展開
  - `parse_pocket_csv()`: CSV解析とデータ変換
  - `create_notion_page()`: Notion APIでのページ作成
  - `check_database_properties()`: データベース構造の検証
